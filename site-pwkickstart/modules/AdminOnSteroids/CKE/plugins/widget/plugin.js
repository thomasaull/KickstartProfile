"use strict";!function(){function e(e){this.editor=e,this.registered={},this.instances={},this.selected=[],this.focused=null,this.widgetHoldingFocusedEditable=null,this._={nextId:0,upcasts:[],upcastCallbacks:[],filters:{}},T(this),y(this),C(this),D(this),b(this),_(this)}function t(e,i,n,a,r){var s=e.editor;CKEDITOR.tools.extend(this,a,{editor:s,id:i,inline:"span"==n.getParent().getName(),element:n,data:CKEDITOR.tools.extend({},"function"==typeof a.defaults?a.defaults():a.defaults),dataReady:!1,inited:!1,ready:!1,edit:t.prototype.edit,focusedEditable:null,definition:a,repository:e,draggable:a.draggable!==!1,_:{downcastFn:a.downcast&&"string"==typeof a.downcast?a.downcasts[a.downcast]:a.downcast}},!0),e.fire("instanceCreated",this),$(this,a),this.init&&this.init(),this.inited=!0,U(this,r),this.isInited()&&s.editable().contains(this.wrapper)&&(this.ready=!0,this.fire("ready"))}function i(e,t,i){CKEDITOR.dom.element.call(this,t.$),this.editor=e,this._={};var n=this.filter=i.filter;CKEDITOR.dtd[this.getName()].p?(this.enterMode=n?n.getAllowedEnterMode(e.enterMode):e.enterMode,this.shiftEnterMode=n?n.getAllowedEnterMode(e.shiftEnterMode,!0):e.shiftEnterMode):this.enterMode=this.shiftEnterMode=CKEDITOR.ENTER_BR}function n(e){var t,i,n,a=e.widgets.registered;for(i in a)t=a[i],n=t.button,n&&e.ui.addButton&&e.ui.addButton(CKEDITOR.tools.capitalize(t.name,!0),{label:n,command:t.name,toolbar:"insert,10"})}function a(e,t){e.addCommand(t.name,{exec:function(e,i){function n(){e.widgets.finalizeCreation(l)}var a=e.widgets.focused;if(a&&a.name==t.name)a.edit();else if(t.insert)t.insert();else if(t.template){var r,s="function"==typeof t.defaults?t.defaults():t.defaults,o=CKEDITOR.dom.element.createFromHtml(t.template.output(s)),d=e.widgets.wrapElement(o,t.name),l=new CKEDITOR.dom.documentFragment(d.getDocument());if(l.append(d),r=e.widgets.initOn(o,t,i&&i.startupData),!r)return void n();var c=r.once("edit",function(t){t.data.dialog?r.once("dialog",function(t){var i,a,s=t.data;i=s.once("ok",n,null,null,20),a=s.once("cancel",function(t){t.data&&t.data.hide===!1||e.widgets.destroy(r,!0)}),s.once("hide",function(){i.removeListener(),a.removeListener()})}):n()},null,null,999);r.edit(),c.removeListener()}},allowedContent:t.allowedContent,requiredContent:t.requiredContent,contentForms:t.contentForms,contentTransformations:t.contentTransformations})}function r(e,t){function i(t,i,n){var a=CKEDITOR.tools.getIndex(e._.upcasts,function(e){return e[2]>n});0>a&&(a=e._.upcasts.length),e._.upcasts.splice(a,0,[t,i,n])}var n,a=t.upcast,r=t.upcastPriority||10;if(a)if("string"==typeof a)for(n=a.split(",");n.length;)i(t.upcasts[n.pop()],t.name,r);else i(a,t.name,r)}function s(e,t){if(e.focused=null,t.isInited()){var i=t.editor.checkDirty();e.fire("widgetBlurred",{widget:t}),t.setFocused(!1),!i&&t.editor.resetDirty()}}function o(e){var i=e.data;if("wysiwyg"==this.editor.mode){var n,a,r,s,o,d=this.editor.editable(),l=this.instances;if(d){for(a in l)l[a].isReady()&&!d.contains(l[a].wrapper)&&this.destroy(l[a],!0);if(i&&i.initOnlyNew)n=this.initOnAll();else{var c=d.find(".cke_widget_wrapper");for(n=[],a=0,r=c.count();r>a;a++)s=c.getItem(a),o=!this.getByElement(s,!0),o&&!f(s,m)&&d.contains(s)&&(s.addClass("cke_widget_new"),n.push(this.initOn(s.getFirst(t.isDomWidgetElement))))}i&&i.focusInited&&1==n.length&&n[0].focus()}}}function d(e){var t=e.parent;t.type==CKEDITOR.NODE_ELEMENT&&t.attributes["data-cke-widget-wrapper"]&&t.replaceWith(e)}function l(e,i){for(var n,a,r=i.find(".cke_widget_wrapper"),s=0,o=r.count();o>s;++s)n=r.getItem(s),a=n.getFirst(t.isDomWidgetElement),a.type==CKEDITOR.NODE_ELEMENT&&a.data("widget")?(a.replace(n),e.wrapElement(a)):n.remove()}function c(e,t,i){if(!i.allowedContent)return null;var n=this._.filters[e];n||(this._.filters[e]=n={});var a=n[t];return a||(n[t]=a=new CKEDITOR.filter(i.allowedContent)),a}function u(e){var i=[],n=e._.upcasts,a=e._.upcastCallbacks;return{toBeWrapped:i,iterator:function(e){var r,s,o,d,l,c;if("data-cke-widget-wrapper"in e.attributes)return e=e.getFirst(t.isParserWidgetElement),e&&i.push([e]),!1;if("data-widget"in e.attributes)return i.push([e]),!1;if(l=n.length){if(e.attributes["data-cke-widget-upcasted"])return!1;for(d=0,c=a.length;c>d;++d)if(a[d](e)===!1)return;for(d=0;l>d;++d)if(r=n[d],o={},s=r[0](e,o))return s instanceof CKEDITOR.htmlParser.element&&(e=s),e.attributes["data-cke-widget-data"]=encodeURIComponent(JSON.stringify(o)),e.attributes["data-cke-widget-upcasted"]=1,i.push([e,r[1]]),!1}}}}function f(e,t){for(var i=e;i=i.getParent();)if(t(i))return!0;return!1}function p(e){return{tabindex:-1,contenteditable:"false","data-cke-widget-wrapper":1,"data-cke-filter":"off","class":"cke_widget_wrapper cke_widget_new cke_widget_"+(e?"inline":"block")}}function g(e,t,i){if(e.type==CKEDITOR.NODE_ELEMENT){var n=CKEDITOR.dtd[e.name];if(n&&!n[i.name]){var a=e.split(t),r=e.parent;return t=a.getIndex(),e.children.length||(t-=1,e.remove()),a.children.length||a.remove(),g(r,t,i)}}e.add(i,t)}function h(e,t){return"boolean"==typeof e.inline?e.inline:!!CKEDITOR.dtd.$inline[t]}function m(e){return e.hasAttribute("data-cke-temp")}function E(e,t){var i,n=e.focusedEditable;if(t==CKEDITOR.CTRL+65){var a=n.getBogus();return i=e.editor.createRange(),i.selectNodeContents(n),a&&i.setEndAt(a,CKEDITOR.POSITION_BEFORE_START),i.select(),!1}if(8==t||46==t){var r=e.editor.getSelection().getRanges();return i=r[0],!(1==r.length&&i.collapsed&&i.checkBoundaryOfElement(n,CKEDITOR[8==t?"START":"END"]))}}function w(e,t,i,n){var a=e.editor;if(a.fire("lockSnapshot"),i){var r=i.data("cke-widget-editable"),s=t.editables[r];e.widgetHoldingFocusedEditable=t,t.focusedEditable=s,i.addClass("cke_widget_editable_focused"),s.filter&&a.setActiveFilter(s.filter),a.setActiveEnterMode(s.enterMode,s.shiftEnterMode)}else n||t.focusedEditable.removeClass("cke_widget_editable_focused"),t.focusedEditable=null,e.widgetHoldingFocusedEditable=null,a.setActiveFilter(null),a.setActiveEnterMode(null,null);a.fire("unlockSnapshot")}function v(e){e.contextMenu&&e.contextMenu.addListener(function(t){var i=e.widgets.getByElement(t,!0);return i?i.fire("contextMenu",{}):void 0})}function k(e,t){return CKEDITOR.tools.trim(t)}function b(e){var i=e.editor,n=CKEDITOR.plugins.lineutils;i.on("dragstart",function(n){var a=n.data.target;if(t.isDomDragHandler(a)){var r=e.getByElement(a);n.data.dataTransfer.setData("cke/widget-id",r.id),i.focus(),r.focus()}}),i.on("drop",function(t){var n,a=t.data.dataTransfer,r=a.getData("cke/widget-id"),s=a.getTransferType(i),o=i.createRange();return""!==r&&s===CKEDITOR.DATA_TRANSFER_CROSS_EDITORS?void t.cancel():void(""!==r&&s==CKEDITOR.DATA_TRANSFER_INTERNAL&&(n=e.instances[r],n&&(o.setStartBefore(n.wrapper),o.setEndAfter(n.wrapper),t.data.dragRange=o,delete CKEDITOR.plugins.clipboard.dragStartContainerChildCount,delete CKEDITOR.plugins.clipboard.dragEndContainerChildCount,t.data.dataTransfer.setData("text/html",i.editable().getHtmlFromRange(o).getHtml()),i.widgets.destroy(n,!0))))}),i.on("contentDom",function(){var a=i.editable();CKEDITOR.tools.extend(e,{finder:new n.finder(i,{lookups:{"default":function(i){if(!i.is(CKEDITOR.dtd.$listItem)&&i.is(CKEDITOR.dtd.$block)&&!t.isDomNestedEditable(i)&&!e._.draggedWidget.wrapper.contains(i)){var n=t.getNestedEditable(a,i);if(n){var r=e._.draggedWidget;if(e.getByElement(n)==r)return;var s=CKEDITOR.filter.instances[n.data("cke-filter")],o=r.requiredContent;if(s&&o&&!s.check(o))return}return CKEDITOR.LINEUTILS_BEFORE|CKEDITOR.LINEUTILS_AFTER}}}}),locator:new n.locator(i),liner:new n.liner(i,{lineStyle:{cursor:"move !important","border-top-color":"#666"},tipLeftStyle:{"border-left-color":"#666"},tipRightStyle:{"border-right-color":"#666"}})},!0)})}function C(e){var i=e.editor;i.on("contentDom",function(){var n,a,r=i.editable(),s=r.isInline()?r:i.document;r.attachListener(s,"mousedown",function(r){var s=r.data.getTarget();if(!s.type)return!1;if(n=e.getByElement(s),a=0,n){if(n.inline&&s.type==CKEDITOR.NODE_ELEMENT&&s.hasAttribute("data-cke-widget-drag-handler"))return a=1,void(e.focused!=n&&i.getSelection().removeAllRanges());t.getNestedEditable(n.wrapper,s)?n=null:(r.data.preventDefault(),CKEDITOR.env.ie||n.focus())}}),r.attachListener(s,"mouseup",function(){a&&n&&n.wrapper&&(a=0,n.focus())}),CKEDITOR.env.ie&&r.attachListener(s,"mouseup",function(){setTimeout(function(){n&&n.wrapper&&r.contains(n.wrapper)&&(n.focus(),n=null)})})}),i.on("doubleclick",function(i){var n=e.getByElement(i.data.element);if(n&&!t.getNestedEditable(n.wrapper,i.data.element))return n.fire("doubleclick",{element:i.data.element})},null,null,1)}function D(e){var t=e.editor;t.on("key",function(t){var i,n=e.focused,a=e.widgetHoldingFocusedEditable;return n?i=n.fire("key",{keyCode:t.data.keyCode}):a&&(i=E(a,t.data.keyCode)),i},null,null,1)}function _(e){function t(t){e.focused&&S(e.focused,"cut"==t.name)}var i=e.editor;i.on("contentDom",function(){var e=i.editable();e.attachListener(e,"copy",t),e.attachListener(e,"cut",t)})}function y(e){var i=e.editor;i.on("selectionCheck",function(){e.fire("checkSelection")}),e.on("checkSelection",e.checkSelection,e),i.on("selectionChange",function(n){var a=t.getNestedEditable(i.editable(),n.data.selection.getStartElement()),r=a&&e.getByElement(a),s=e.widgetHoldingFocusedEditable;s?s===r&&s.focusedEditable.equals(a)||(w(e,s,null),r&&a&&w(e,r,a)):r&&a&&w(e,r,a)}),i.on("dataReady",function(){I(e).commit()}),i.on("blur",function(){var t;(t=e.focused)&&s(e,t),(t=e.widgetHoldingFocusedEditable)&&w(e,t,null)})}function T(e){O(e),R(e),e.on("checkWidgets",o),e.editor.on("contentDomInvalidated",e.checkWidgets,e)}function R(e){var i=e.editor,n={};i.on("toDataFormat",function(i){var a=CKEDITOR.tools.getNextNumber(),r=[];i.data.downcastingSessionId=a,n[a]=r,i.data.dataValue.forEach(function(i){var n,a,s=i.attributes;if("data-cke-widget-id"in s)n=e.instances[s["data-cke-widget-id"]],n&&(a=i.getFirst(t.isParserWidgetElement),r.push({wrapper:i,element:a,widget:n,editables:{}}),"1"!=a.attributes["data-cke-widget-keep-attr"]&&delete a.attributes["data-widget"]);else if("data-cke-widget-editable"in s)return r[r.length-1].editables[s["data-cke-widget-editable"]]=i,!1},CKEDITOR.NODE_ELEMENT,!0)},null,null,8),i.on("toDataFormat",function(e){if(e.data.downcastingSessionId)for(var t,i,a,r,s,o,d=n[e.data.downcastingSessionId];t=d.shift();){i=t.widget,a=t.element,r=i._.downcastFn&&i._.downcastFn.call(i,a);for(o in t.editables)s=t.editables[o],delete s.attributes.contenteditable,s.setHtml(i.editables[o].getData());r||(r=a),t.wrapper.replaceWith(r)}},null,null,13),i.on("contentDomUnload",function(){e.destroyAll(!0)})}function O(e){var i,n,a=e.editor;a.on("toHtml",function(n){var a,r=u(e);for(n.data.dataValue.forEach(r.iterator,CKEDITOR.NODE_ELEMENT,!0);a=r.toBeWrapped.pop();)d(a[0]),e.wrapElement(a[0],a[1]);i=n.data.protectedWhitespaces?3==n.data.dataValue.children.length&&t.isParserWidgetWrapper(n.data.dataValue.children[1]):1==n.data.dataValue.children.length&&t.isParserWidgetWrapper(n.data.dataValue.children[0])},null,null,8),a.on("dataReady",function(){n&&l(e,a.editable()),n=0,e.destroyAll(!0),e.initOnAll()}),a.on("loadSnapshot",function(t){/data-cke-widget/.test(t.data)&&(n=1),e.destroyAll(!0)},null,null,9),a.on("paste",function(e){var i=e.data;if(i.dataValue=i.dataValue.replace(Y,k),i.range){var n=t.getNestedEditable(a.editable(),i.range.startContainer);if(n){var r=CKEDITOR.filter.instances[n.data("cke-filter")];r&&a.setActiveFilter(r)}}}),a.on("afterInsertHtml",function(t){t.data.intoRange?e.checkWidgets({initOnlyNew:!0}):(a.fire("lockSnapshot"),e.checkWidgets({initOnlyNew:!0,focusInited:i}),a.fire("unlockSnapshot"))})}function I(e){var t=e.selected,i=[],n=t.slice(0),a=null;return{select:function(e){CKEDITOR.tools.indexOf(t,e)<0&&i.push(e);var a=CKEDITOR.tools.indexOf(n,e);return a>=0&&n.splice(a,1),this},focus:function(e){return a=e,this},commit:function(){var r,o,d=e.focused!==a;for(e.editor.fire("lockSnapshot"),d&&(r=e.focused)&&s(e,r);r=n.pop();)t.splice(CKEDITOR.tools.indexOf(t,r),1),r.isInited()&&(o=r.editor.checkDirty(),r.setSelected(!1),!o&&r.editor.resetDirty());for(d&&a&&(o=e.editor.checkDirty(),e.focused=a,e.fire("widgetFocused",{widget:a}),a.setFocused(!0),!o&&e.editor.resetDirty());r=i.pop();)t.push(r),r.setSelected(!0);e.editor.fire("unlockSnapshot")}}}function K(e,t,i){var n,a=0,r=A(t),s=e.data.classes||{};if(r){for(s=CKEDITOR.tools.clone(s);n=r.pop();)i?s[n]||(a=s[n]=1):s[n]&&(delete s[n],a=1);a&&e.setData("classes",s)}}function N(e){e.cancel()}function S(e,t){var i=e.editor,n=i.document;if(!n.getById("cke_copybin")){var a=i.blockless||CKEDITOR.env.ie?"span":"div",r=n.createElement(a),s=n.createElement(a),o=CKEDITOR.env.ie&&CKEDITOR.env.version<9;s.setAttributes({id:"cke_copybin","data-cke-temp":"1"}),r.setStyles({position:"absolute",width:"1px",height:"1px",overflow:"hidden"}),r.setStyle("ltr"==i.config.contentsLangDirection?"left":"right","-5000px");var d=i.createRange();d.setStartBefore(e.wrapper),d.setEndAfter(e.wrapper),r.setHtml('<span data-cke-copybin-start="1">​</span>'+i.editable().getHtmlFromRange(d).getHtml()+'<span data-cke-copybin-end="1">​</span>'),i.fire("saveSnapshot"),i.fire("lockSnapshot"),s.append(r),i.editable().append(s);var l=i.on("selectionChange",N,null,null,0),c=e.repository.on("checkSelection",N,null,null,0);if(o)var u=n.getDocumentElement().$,f=u.scrollTop;d=i.createRange(),d.selectNodeContents(r),d.select(),o&&(u.scrollTop=f),setTimeout(function(){t||e.focus(),s.remove(),l.removeListener(),c.removeListener(),i.fire("unlockSnapshot"),t&&(e.repository.del(e),i.fire("saveSnapshot"))},100)}}function A(e){var t=e.getDefinition().attributes,i=t&&t["class"];return i?i.split(/\s+/):null}function L(){var e=CKEDITOR.document.getActive(),t=this.editor,i=t.editable();(i.isInline()?i:t.document.getWindow().getFrame()).equals(e)&&t.focusManager.focus(i)}function M(){CKEDITOR.env.gecko&&this.editor.unlockSelection(),CKEDITOR.env.webkit||(this.editor.forceNextSelectionCheck(),this.editor.selectionChange(1))}function x(e){var t=null;e.on("data",function(){var e,i=this.data.classes;if(t!=i){for(e in t)i&&i[e]||this.removeClass(e);for(e in i)this.addClass(e);t=i}})}function F(e){function t(){return this.editor.lang.widget.label.replace(/%1/,this.pathName||this.element.getName())}e.on("data",function(){if(e.wrapper){var i=this.getLabel?this.getLabel():t.call(this);e.wrapper.setAttribute("role","region"),e.wrapper.setAttribute("aria-label",i)}},null,null,9999)}function W(e){if(e.draggable){var i,n=e.editor,a=e.wrapper.getLast(t.isDomDragHandlerContainer);a?i=a.findOne("img"):(a=new CKEDITOR.dom.element("span",n.document),a.setAttributes({"class":"cke_reset cke_widget_drag_handler_container",style:"background:rgba(220,220,220,0.5);background-image:url("+n.plugins.widget.path+"images/handle.png)"}),i=new CKEDITOR.dom.element("img",n.document),i.setAttributes({"class":"cke_reset cke_widget_drag_handler","data-cke-widget-drag-handler":"1",src:CKEDITOR.tools.transparentImageData,width:j,title:n.lang.widget.move,height:j,role:"presentation"}),e.inline&&i.setAttribute("draggable","true"),a.append(i),e.wrapper.append(a)),e.wrapper.on("dragover",function(e){e.data.preventDefault()}),e.wrapper.on("mouseenter",e.updateDragHandlerPosition,e),setTimeout(function(){e.on("data",e.updateDragHandlerPosition,e)},50),e.inline||(i.on("mousedown",H,e),CKEDITOR.env.ie&&CKEDITOR.env.version<9&&i.on("dragstart",function(e){e.data.preventDefault(!0)})),e.dragHandlerContainer=a}}function H(e){function t(){var t;for(f.reset();t=l.pop();)t.removeListener();B.call(this,c,e.sender)}var i,n,a=this.repository.finder,r=this.repository.locator,s=this.repository.liner,o=this.editor,d=o.editable(),l=[],c=[];this.repository._.draggedWidget=this;var u=a.greedySearch(),f=CKEDITOR.tools.eventsBuffer(50,function(){i=r.locate(u),c=r.sort(n,1),c.length&&(s.prepare(u,i),s.placeLine(c[0]),s.cleanup())});d.addClass("cke_widget_dragging"),l.push(d.on("mousemove",function(e){n=e.data.$.clientY,f.input()})),o.fire("dragstart",{target:e.sender}),l.push(o.document.once("mouseup",t,this)),d.isInline()||l.push(CKEDITOR.document.once("mouseup",t,this))}function B(e,t){var i=this.repository.finder,n=this.repository.liner,a=this.editor,r=this.editor.editable();if(!CKEDITOR.tools.isEmpty(n.visible)){var s=i.getRange(e[0]);this.focus(),a.fire("drop",{dropRange:s,target:s.startContainer})}r.removeClass("cke_widget_dragging"),n.hideVisible(),a.fire("dragend",{target:t})}function P(e){var t,i,n=e.editables;if(e.editables={},e.editables)for(t in n)i=n[t],e.initEditable(t,"string"==typeof i?{selector:i}:i)}function q(e){if(e.mask){var t=e.wrapper.findOne(".cke_widget_mask");t||(t=new CKEDITOR.dom.element("img",e.editor.document),t.setAttributes({src:CKEDITOR.tools.transparentImageData,"class":"cke_reset cke_widget_mask"}),e.wrapper.append(t)),e.mask=t}}function V(e){if(e.parts){var t,i,n={};for(i in e.parts)t=e.wrapper.findOne(e.parts[i]),n[i]=t;e.parts=n}}function $(e,i){z(e),V(e),P(e),q(e),W(e),x(e),F(e),CKEDITOR.env.ie&&CKEDITOR.env.version<9&&e.wrapper.on("dragstart",function(i){var n=i.data.getTarget();t.getNestedEditable(e,n)||e.inline&&t.isDomDragHandler(n)||i.data.preventDefault()}),e.wrapper.removeClass("cke_widget_new"),e.element.addClass("cke_widget_element"),e.on("key",function(t){var i=t.data.keyCode;if(13==i)e.edit();else{if(i==CKEDITOR.CTRL+67||i==CKEDITOR.CTRL+88)return void S(e,i==CKEDITOR.CTRL+88);if(i in G||CKEDITOR.CTRL&i||CKEDITOR.ALT&i)return}return!1},null,null,999),e.on("doubleclick",function(t){e.edit()&&t.cancel()}),i.data&&e.on("data",i.data),i.edit&&e.on("edit",i.edit)}function U(e,t){var i=e.element.data("cke-widget-data");i&&e.setData(JSON.parse(decodeURIComponent(i))),t&&e.setData(t),e.data.classes||e.setData("classes",e.getClasses()),e.dataReady=!0,J(e),e.fire("data",e.data)}function z(e){var t=e.wrapper=e.element.getParent();t.setAttribute("data-cke-widget-id",e.id)}function J(e){e.element.data("cke-widget-data",encodeURIComponent(JSON.stringify(e.data)))}var j=15;CKEDITOR.plugins.add("widget",{lang:"en",requires:"lineutils,clipboard",onLoad:function(){CKEDITOR.addCss(".cke_widget_wrapper{position:relative;outline:none}.cke_widget_inline{display:inline-block}.cke_widget_wrapper:hover>.cke_widget_element{outline:2px solid yellow;cursor:default}.cke_widget_wrapper:hover .cke_widget_editable{outline:2px solid yellow}.cke_widget_wrapper.cke_widget_focused>.cke_widget_element,.cke_widget_wrapper .cke_widget_editable.cke_widget_editable_focused{outline:2px solid #ace}.cke_widget_editable{cursor:text}.cke_widget_drag_handler_container{position:absolute;width:"+j+"px;height:0;display:none;opacity:0.75;transition:height 0s 0.2s;line-height:0}.cke_widget_wrapper:hover>.cke_widget_drag_handler_container{height:"+j+"px;transition:none}.cke_widget_drag_handler_container:hover{opacity:1}img.cke_widget_drag_handler{cursor:move;width:"+j+"px;height:"+j+"px;display:inline-block}.cke_widget_mask{position:absolute;top:0;left:0;width:100%;height:100%;display:block}.cke_editable.cke_widget_dragging, .cke_editable.cke_widget_dragging *{cursor:move !important}")},beforeInit:function(t){t.widgets=new e(t)},afterInit:function(e){n(e),v(e)}}),e.prototype={MIN_SELECTION_CHECK_INTERVAL:500,add:function(e,t){return t=CKEDITOR.tools.prototypedCopy(t),t.name=e,t._=t._||{},this.editor.fire("widgetDefinition",t),t.template&&(t.template=new CKEDITOR.template(t.template)),a(this.editor,t),r(this,t),this.registered[e]=t,t},addUpcastCallback:function(e){this._.upcastCallbacks.push(e)},checkSelection:function(){var e,i=this.editor.getSelection(),n=i.getSelectedElement(),a=I(this);if(n&&(e=this.getByElement(n,!0)))return a.focus(e).select(e).commit();var r=i.getRanges()[0];if(!r||r.collapsed)return a.commit();var s,o=new CKEDITOR.dom.walker(r);for(o.evaluator=t.isDomWidgetWrapper;s=o.next();)a.select(this.getByElement(s));a.commit()},checkWidgets:function(e){this.fire("checkWidgets",CKEDITOR.tools.copy(e||{}))},del:function(e){if(this.focused===e){var t,i=e.editor,n=i.createRange();(t=n.moveToClosestEditablePosition(e.wrapper,!0))||(t=n.moveToClosestEditablePosition(e.wrapper,!1)),t&&i.getSelection().selectRanges([n])}e.wrapper.remove(),this.destroy(e,!0)},destroy:function(e,t){this.widgetHoldingFocusedEditable===e&&w(this,e,null,t),e.destroy(t),delete this.instances[e.id],this.fire("instanceDestroyed",e)},destroyAll:function(e,t){var i,n,a=this.instances;if(!t||e)for(n in a)i=a[n],this.destroy(i,e);else for(var r=t.find(".cke_widget_wrapper"),s=r.count(),o=0;s>o;++o)i=this.getByElement(r.getItem(o),!0),i&&this.destroy(i)},finalizeCreation:function(e){var i=e.getFirst();if(i&&t.isDomWidgetWrapper(i)){this.editor.insertElement(i);var n=this.getByElement(i);n.ready=!0,n.fire("ready"),n.focus()}},getByElement:function(){function e(e){return e.is(t)&&e.data("cke-widget-id")}var t={div:1,span:1};return function(t,i){if(!t)return null;var n=e(t);if(!i&&!n){var a=this.editor.editable();do t=t.getParent();while(t&&!t.equals(a)&&!(n=e(t)))}return this.instances[n]||null}}(),initOn:function(e,i,n){if(i?"string"==typeof i&&(i=this.registered[i]):i=this.registered[e.data("widget")],!i)return null;var a=this.wrapElement(e,i.name);if(a){if(a.hasClass("cke_widget_new")){var r=new t(this,this._.nextId++,e,i,n);return r.isInited()?(this.instances[r.id]=r,r):null}return this.getByElement(e)}return null},initOnAll:function(e){for(var i,n=(e||this.editor.editable()).find(".cke_widget_new"),a=[],r=n.count();r--;)i=this.initOn(n.getItem(r).getFirst(t.isDomWidgetElement)),i&&a.push(i);return a},onWidget:function(e){var t=Array.prototype.slice.call(arguments);t.shift();for(var i in this.instances){var n=this.instances[i];n.name==e&&n.on.apply(n,t)}this.on("instanceCreated",function(i){var n=i.data;n.name==e&&n.on.apply(n,t)})},parseElementClasses:function(e){if(!e)return null;e=CKEDITOR.tools.trim(e).split(/\s+/);for(var t,i={},n=0;t=e.pop();)-1==t.indexOf("cke_")&&(i[t]=n=1);return n?i:null},wrapElement:function(e,t){var i,n,a=null;if(e instanceof CKEDITOR.dom.element){if(i=this.registered[t||e.data("widget")],!i)return null;if(a=e.getParent(),a&&a.type==CKEDITOR.NODE_ELEMENT&&a.data("cke-widget-wrapper"))return a;e.hasAttribute("data-cke-widget-keep-attr")||e.data("cke-widget-keep-attr",e.data("widget")?1:0),t&&e.data("widget",t),n=h(i,e.getName()),a=new CKEDITOR.dom.element(n?"span":"div"),a.setAttributes(p(n)),a.data("cke-display-name",i.pathName?i.pathName:e.getName()),e.getParent(!0)&&a.replace(e),e.appendTo(a)}else if(e instanceof CKEDITOR.htmlParser.element){if(i=this.registered[t||e.attributes["data-widget"]],!i)return null;if(a=e.parent,a&&a.type==CKEDITOR.NODE_ELEMENT&&a.attributes["data-cke-widget-wrapper"])return a;"data-cke-widget-keep-attr"in e.attributes||(e.attributes["data-cke-widget-keep-attr"]=e.attributes["data-widget"]?1:0),t&&(e.attributes["data-widget"]=t),n=h(i,e.name),a=new CKEDITOR.htmlParser.element(n?"span":"div",p(n)),a.attributes["data-cke-display-name"]=i.pathName?i.pathName:e.name;var r,s=e.parent;s&&(r=e.getIndex(),e.remove()),a.add(e),s&&g(s,r,a)}return a},_tests_createEditableFilter:c},CKEDITOR.event.implementOn(e.prototype),t.prototype={addClass:function(e){this.element.addClass(e)},applyStyle:function(e){K(this,e,1)},checkStyleActive:function(e){var t,i=A(e);if(!i)return!1;for(;t=i.pop();)if(!this.hasClass(t))return!1;return!0},destroy:function(e){if(this.fire("destroy"),this.editables)for(var t in this.editables)this.destroyEditable(t,e);e||("0"==this.element.data("cke-widget-keep-attr")&&this.element.removeAttribute("data-widget"),this.element.removeAttributes(["data-cke-widget-data","data-cke-widget-keep-attr"]),this.element.removeClass("cke_widget_element"),this.element.replace(this.wrapper)),this.wrapper=null},destroyEditable:function(e,t){var i=this.editables[e];i.removeListener("focus",M),i.removeListener("blur",L),this.editor.focusManager.remove(i),t||(this.repository.destroyAll(!1,i),i.removeClass("cke_widget_editable"),i.removeClass("cke_widget_editable_focused"),i.removeAttributes(["contenteditable","data-cke-widget-editable","data-cke-enter-mode"])),delete this.editables[e]},edit:function(){var e={dialog:this.dialog},t=this;return this.fire("edit",e)!==!1&&e.dialog?(this.editor.openDialog(e.dialog,function(e){var i,n;t.fire("dialog",e)!==!1&&(i=e.on("show",function(){e.setupContent(t)}),n=e.on("ok",function(){var i,n=t.on("data",function(e){i=1,e.cancel()},null,null,0);t.editor.fire("saveSnapshot"),e.commitContent(t),n.removeListener(),i&&(t.fire("data",t.data),t.editor.fire("saveSnapshot"))}),e.once("hide",function(){i.removeListener(),n.removeListener()}))}),!0):!1},getClasses:function(){return this.repository.parseElementClasses(this.element.getAttribute("class"))},hasClass:function(e){return this.element.hasClass(e)},initEditable:function(e,t){var n=this._findOneNotNested(t.selector);return n&&n.is(CKEDITOR.dtd.$editable)?(n=new i(this.editor,n,{filter:c.call(this.repository,this.name,e,t)}),this.editables[e]=n,n.setAttributes({contenteditable:"true","data-cke-widget-editable":e,"data-cke-enter-mode":n.enterMode}),n.filter&&n.data("cke-filter",n.filter.id),n.addClass("cke_widget_editable"),n.removeClass("cke_widget_editable_focused"),t.pathName&&n.data("cke-display-name",t.pathName),this.editor.focusManager.add(n),n.on("focus",M,this),CKEDITOR.env.ie&&n.on("blur",L,this),n._.initialSetData=!0,n.setData(n.getHtml()),!0):!1},_findOneNotNested:function(e){for(var i,n,a=this.wrapper.find(e),r=0;r<a.count();r++)if(i=a.getItem(r),n=i.getAscendant(t.isDomWidgetWrapper),this.wrapper.equals(n))return i;return null},isInited:function(){return!(!this.wrapper||!this.inited)},isReady:function(){return this.isInited()&&this.ready},focus:function(){var e=this.editor.getSelection();if(e){var t=this.editor.checkDirty();e.fake(this.wrapper),!t&&this.editor.resetDirty()}this.editor.focus()},removeClass:function(e){this.element.removeClass(e)},removeStyle:function(e){K(this,e,0)},setData:function(e,t){var i=this.data,n=0;if("string"==typeof e)i[e]!==t&&(i[e]=t,n=1);else{var a=e;for(e in a)i[e]!==a[e]&&(n=1,i[e]=a[e])}return n&&this.dataReady&&(J(this),this.fire("data",i)),this},setFocused:function(e){return this.wrapper[e?"addClass":"removeClass"]("cke_widget_focused"),this.fire(e?"focus":"blur"),this},setSelected:function(e){return this.wrapper[e?"addClass":"removeClass"]("cke_widget_selected"),this.fire(e?"select":"deselect"),this},updateDragHandlerPosition:function(){var e=this.editor,t=this.element.$,i=this._.dragHandlerOffset,n={x:t.offsetLeft,y:t.offsetTop-j};if(!i||n.x!=i.x||n.y!=i.y){var a=e.checkDirty();e.fire("lockSnapshot"),this.dragHandlerContainer.setStyles({top:n.y+"px",left:n.x+"px",display:"block"}),e.fire("unlockSnapshot"),!a&&e.resetDirty(),this._.dragHandlerOffset=n}}},CKEDITOR.event.implementOn(t.prototype),t.getNestedEditable=function(e,i){return!i||i.equals(e)?null:t.isDomNestedEditable(i)?i:t.getNestedEditable(e,i.getParent())},t.isDomDragHandler=function(e){return e.type==CKEDITOR.NODE_ELEMENT&&e.hasAttribute("data-cke-widget-drag-handler")},t.isDomDragHandlerContainer=function(e){return e.type==CKEDITOR.NODE_ELEMENT&&e.hasClass("cke_widget_drag_handler_container")},t.isDomNestedEditable=function(e){return e.type==CKEDITOR.NODE_ELEMENT&&e.hasAttribute("data-cke-widget-editable")},t.isDomWidgetElement=function(e){return e.type==CKEDITOR.NODE_ELEMENT&&e.hasAttribute("data-widget")},t.isDomWidgetWrapper=function(e){return e.type==CKEDITOR.NODE_ELEMENT&&e.hasAttribute("data-cke-widget-wrapper")},t.isParserWidgetElement=function(e){return e.type==CKEDITOR.NODE_ELEMENT&&!!e.attributes["data-widget"]},t.isParserWidgetWrapper=function(e){return e.type==CKEDITOR.NODE_ELEMENT&&!!e.attributes["data-cke-widget-wrapper"]},i.prototype=CKEDITOR.tools.extend(CKEDITOR.tools.prototypedCopy(CKEDITOR.dom.element.prototype),{setData:function(e){this._.initialSetData||this.editor.widgets.destroyAll(!1,this),this._.initialSetData=!1,e=this.editor.dataProcessor.toHtml(e,{context:this.getName(),filter:this.filter,enterMode:this.enterMode}),this.setHtml(e),this.editor.widgets.initOnAll(this)},getData:function(){return this.editor.dataProcessor.toDataFormat(this.getHtml(),{context:this.getName(),filter:this.filter,enterMode:this.enterMode})}});var Y=new RegExp('^(?:<(?:div|span)(?: data-cke-temp="1")?(?: id="cke_copybin")?(?: data-cke-temp="1")?>)?(?:<(?:div|span)(?: style="[^"]+")?>)?<span [^>]*data-cke-copybin-start="1"[^>]*>.?</span>([\\s\\S]+)<span [^>]*data-cke-copybin-end="1"[^>]*>.?</span>(?:</(?:div|span)>)?(?:</(?:div|span)>)?$',"i"),G={37:1,38:1,39:1,40:1,8:1,46:1};!function(){function e(){}function i(e,t,i){if(!i)return!1;if(!this.checkElement(e))return!1;var n=i.widgets.getByElement(e,!0);return n&&n.checkStyleActive(this)}CKEDITOR.style.addCustomHandler({type:"widget",setup:function(e){this.widget=e.widget},apply:function(e){e instanceof CKEDITOR.editor&&this.checkApplicable(e.elementPath(),e)&&e.widgets.focused.applyStyle(this)},remove:function(e){e instanceof CKEDITOR.editor&&this.checkApplicable(e.elementPath(),e)&&e.widgets.focused.removeStyle(this)},checkActive:function(e,t){return this.checkElementMatch(e.lastElement,0,t)},checkApplicable:function(e,t){return t instanceof CKEDITOR.editor?this.checkElement(e.lastElement):!1},checkElementMatch:i,checkElementRemovable:i,checkElement:function(e){if(!t.isDomWidgetWrapper(e))return!1;var i=e.getFirst(t.isDomWidgetElement);return i&&i.data("widget")==this.widget},buildPreview:function(e){return e||this._.definition.name},toAllowedContentRules:function(e){if(!e)return null;var t,i=e.widgets.registered[this.widget],n={};return i?i.styleableElements?(t=this.getClassesArray())?(n[i.styleableElements]={classes:t,propertiesOnly:!0},n):null:i.styleToAllowedContentRules?i.styleToAllowedContentRules(this):null:null},getClassesArray:function(){var e=this._.definition.attributes&&this._.definition.attributes["class"];return e?CKEDITOR.tools.trim(e).split(/\s+/):null},applyToRange:e,removeFromRange:e,applyToObject:e})}(),CKEDITOR.plugins.widget=t,t.repository=e,t.nestedEditable=i}();