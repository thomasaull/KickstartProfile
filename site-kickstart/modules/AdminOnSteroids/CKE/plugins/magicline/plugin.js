"use strict";!function(){function e(e){function t(){function t(t){y.debug.groupStart("CheckMouse"),y.debug.startTimer(),y.mouse=t,y.trigger=null,p=null,C(y),a&&!y.hiddenMode&&e.focusManager.hasFocus&&!y.line.mouseNear()&&(y.element=J(y,!0))&&((y.trigger=v(y)||x(y)||ee(y))&&!E(y,y.trigger.upper||y.trigger.lower)?y.line.attach().place():(y.trigger=null,y.line.detach()),y.debug.showTrigger(y.trigger),y.debug.mousePos(t.y,y.element),a=!1),y.debug.stopTimer(),y.debug.groupEnd()}var c=e.editable(),h=e.document,m=e.window;O(y,{editable:c,inInlineMode:c.isInline(),doc:h,win:m,hotNode:null},!0),y.boundary=y.inInlineMode?y.editable:y.doc.getDocumentElement(),c.is(S.$inline)||(y.inInlineMode&&!f(c)&&c.setStyles({position:"relative",top:null,left:null}),d.call(this,y),C(y),c.attachListener(e,"beforeUndoImage",function(){y.line.detach()}),c.attachListener(e,"beforeGetData",function(){y.line.wrap.getParent()&&(y.line.detach(),e.once("getData",function(){y.line.attach()},null,null,1e3))},null,null,0),c.attachListener(y.inInlineMode?h:h.getWindow().getFrame(),"mouseout",function(t){if("wysiwyg"==e.mode)if(y.inInlineMode){var n={x:t.data.$.clientX,y:t.data.$.clientY};C(y),D(y,!0);var i=y.view.editable,o=y.view.scroll;l(n.x,i.left-o.x,i.right-o.x)&&l(n.y,i.top-o.y,i.bottom-o.y)||(clearTimeout(p),p=null,y.line.detach())}else clearTimeout(p),p=null,y.line.detach()}),c.attachListener(c,"keyup",function(){y.hiddenMode=0,y.debug.showHidden(y.hiddenMode)}),c.attachListener(c,"keydown",function(t){if("wysiwyg"==e.mode){var n=t.data.getKeystroke();switch(n){case 2228240:case 16:y.hiddenMode=1,y.line.detach()}y.debug.showHidden(y.hiddenMode)}}),c.attachListener(y.inInlineMode?c:h,"mousemove",function(n){if(a=!0,"wysiwyg"==e.mode&&!e.readOnly&&!p){var i={x:n.data.$.clientX,y:n.data.$.clientY};p=setTimeout(function(){t(i)},30)}}),c.attachListener(m,"scroll",function(){"wysiwyg"==e.mode&&(y.line.detach(),z.webkit&&(y.hiddenMode=1,clearTimeout(o),o=setTimeout(function(){y.mouseDown||(y.hiddenMode=0),y.debug.showHidden(y.hiddenMode)},50),y.debug.showHidden(y.hiddenMode)))}),c.attachListener(N?h:m,"mousedown",function(){"wysiwyg"==e.mode&&(y.line.detach(),y.hiddenMode=1,y.mouseDown=1,y.debug.showHidden(y.hiddenMode))}),c.attachListener(N?h:m,"mouseup",function(){y.hiddenMode=0,y.mouseDown=0,y.debug.showHidden(y.hiddenMode)}),e.addCommand("accessPreviousSpace",u(y)),e.addCommand("accessNextSpace",u(y,!0)),e.setKeystroke([[b.magicline_keystrokePrevious,"accessPreviousSpace"],[b.magicline_keystrokeNext,"accessNextSpace"]]),e.on("loadSnapshot",function(){var t,n,i;for(var o in{p:1,br:1,div:1})for(t=e.document.getElementsByTag(o),i=t.count();i--;)if((n=t.getItem(i)).data("cke-magicline-hot"))return y.hotNode=n,void(y.lastCmdDirection="true"===n.data("cke-magicline-dir"))}),this.backdoor={accessFocusSpace:s,boxTrigger:n,isLine:g,getAscendantTrigger:i,getNonEmptyNeighbour:r,getSize:T,that:y,triggerEdge:x,triggerEditable:v,triggerExpand:ee})}var o,a,p,b=e.config,m=b.magicline_triggerOffset||30,w=b.enterMode,y={editor:e,enterMode:w,triggerOffset:m,holdDistance:0|m*(b.magicline_holdDistance||.5),boxColor:b.magicline_color||"#ff0000",rtl:"rtl"==b.contentsLangDirection,tabuList:["data-cke-hidden-sel"].concat(b.magicline_tabuList||[]),triggers:b.magicline_everywhere?W:{table:1,hr:1,div:1,ul:1,ol:1,dl:1,form:1,blockquote:1}};try{y.debug=window.top.DEBUG}catch(R){}y.debug=y.debug||{groupEnd:function(){},groupStart:function(){},log:function(){},logElements:function(){},logElementsEnd:function(){},logEnd:function(){},mousePos:function(){},showHidden:function(){},showTrigger:function(){},startTimer:function(){},stopTimer:function(){}},y.isRelevant=function(e){return c(e)&&!g(y,e)&&!h(e)},e.on("contentDom",t,this)}function t(e,t,n){return c(t)&&c(n)&&n.equals(t.getNext(function(e){return!(Q(e)||Z(e)||h(e))}))}function n(e){this.upper=e[0],this.lower=e[1],this.set.apply(this,e.slice(2))}function i(e){var t,n=e.element;if(n&&c(n)){if(t=n.getAscendant(e.triggers,!0),t&&e.editable.contains(t)){var i=a(t);return"true"==i.getAttribute("contenteditable")?t:i.is(e.triggers)?i:null}return null}return null}function o(e,t,n){y(e,t),y(e,n);var i=t.size.bottom,o=n.size.top;return i&&o?0|(i+o)/2:i||o}function r(e,t,n){return t=t[n?"getPrevious":"getNext"](function(t){return b(t)&&!Q(t)||c(t)&&!h(t)&&!g(e,t)})}function l(e,t,n){return e>t&&n>e}function a(e,t){if(e.data("cke-editable"))return null;for(t||(e=e.getParent());e;){if(e.data("cke-editable"))return null;if(e.hasAttribute("contenteditable"))return e;e=e.getParent()}return null}function d(e){var t=e.doc,n=M('<span contenteditable="false" style="'+X+"position:absolute;border-top:1px dashed "+e.boxColor+'"></span>',t),i=CKEDITOR.getUrl(this.path+"images/"+(z.hidpi?"hidpi/":"")+"icon"+(e.rtl?"-rtl":"")+".png");O(n,{attach:function(){return this.wrap.getParent()||this.wrap.appendTo(e.editable,!0),this},lineChildren:[O(M('<span title="'+e.editor.lang.magicline.title+'" contenteditable="false">&#8629;</span>',t),{base:X+"height:17px;width:17px;"+(e.rtl?"left":"right")+":17px;background:url("+i+") center no-repeat "+e.boxColor+";cursor:pointer;"+(z.hc?"font-size: 15px;line-height:14px;border:1px solid #fff;text-align:center;":"")+(z.hidpi?"background-size: 9px 10px;":""),looks:["top:-8px; border-radius: 2px;","top:-17px; border-radius: 2px 2px 0px 0px;","top:-1px; border-radius: 0px 0px 2px 2px;"]}),O(M(Y,t),{base:j+"left:0px;border-left-color:"+e.boxColor+";",looks:["border-width:8px 0 8px 8px;top:-8px","border-width:8px 0 0 8px;top:-8px","border-width:0 0 8px 8px;top:0px"]}),O(M(Y,t),{base:j+"right:0px;border-right-color:"+e.boxColor+";",looks:["border-width:8px 8px 8px 0;top:-8px","border-width:8px 8px 0 0;top:-8px","border-width:0 8px 8px 0;top:0px"]})],detach:function(){return this.wrap.getParent()&&this.wrap.remove(),this},mouseNear:function(){e.debug.groupStart("mouseNear"),y(e,this);var t=e.holdDistance,n=this.size;return n&&l(e.mouse.y,n.top-t,n.bottom+t)&&l(e.mouse.x,n.left-t,n.right+t)?(e.debug.logEnd("Mouse is near."),!0):(e.debug.logEnd("Mouse isn't near."),!1)},place:function(){var t=e.view,n=e.editable,i=e.trigger,o=i.upper,r=i.lower,a=o||r,d=a.getParent(),s={};this.trigger=i,o&&y(e,o,!0),r&&y(e,r,!0),y(e,d,!0),e.inInlineMode&&D(e,!0),d.equals(n)?(s.left=t.scroll.x,s.right=-t.scroll.x,s.width=""):(s.left=a.size.left-a.size.margin.left+t.scroll.x-(e.inInlineMode?t.editable.left+t.editable.border.left:0),s.width=a.size.outerWidth+a.size.margin.left+a.size.margin.right+t.scroll.x,s.right=""),o&&r?o.size.margin.bottom===r.size.margin.top?s.top=0|o.size.bottom+o.size.margin.bottom/2:o.size.margin.bottom<r.size.margin.top?s.top=o.size.bottom+o.size.margin.bottom:s.top=o.size.bottom+o.size.margin.bottom-r.size.margin.top:o?r||(s.top=o.size.bottom+o.size.margin.bottom):s.top=r.size.top-r.size.margin.top,i.is(B)||l(s.top,t.scroll.y-15,t.scroll.y+5)?(s.top=e.inInlineMode?0:t.scroll.y,this.look(B)):i.is($)||l(s.top,t.pane.bottom-5,t.pane.bottom+15)?(s.top=e.inInlineMode?t.editable.height+t.editable.padding.top+t.editable.padding.bottom:t.pane.bottom-1,this.look($)):(e.inInlineMode&&(s.top-=t.editable.top+t.editable.border.top),this.look(q)),e.inInlineMode&&(s.top--,s.top+=t.editable.scroll.top,s.left+=t.editable.scroll.left);for(var u in s)s[u]=CKEDITOR.tools.cssLength(s[u]);this.setStyles(s)},look:function(e){if(this.oldLook!=e){for(var t,n=this.lineChildren.length;n--;)(t=this.lineChildren[n]).setAttribute("style",t.base+t.looks[0|e/2]);this.oldLook=e}},wrap:new I("span",e.doc)});for(var o=n.lineChildren.length;o--;)n.lineChildren[o].appendTo(n);n.look(q),n.appendTo(n.wrap),n.unselectable(),n.lineChildren[0].on("mouseup",function(t){n.detach(),s(e,function(t){var n=e.line.trigger;t[n.is(L)?"insertBefore":"insertAfter"](n.is(L)?n.lower:n.upper)},!0),e.editor.focus(),z.ie||e.enterMode==CKEDITOR.ENTER_BR||e.hotNode.scrollIntoView(),t.data.preventDefault(!0)}),n.on("mousedown",function(e){e.data.preventDefault(!0)}),e.line=n}function s(e,t,n){var i,o=new CKEDITOR.dom.range(e.doc),r=e.editor;if(z.ie&&e.enterMode==CKEDITOR.ENTER_BR)i=e.doc.createText(F);else{var l=a(e.element,!0),d=l&&l.data("cke-enter-mode")||e.enterMode;if(i=new I(k[d],e.doc),!i.is("br")){var s=e.doc.createText(F);s.appendTo(i)}}n&&r.fire("saveSnapshot"),t(i),o.moveToPosition(i,CKEDITOR.POSITION_AFTER_START),r.getSelection().selectRanges([o]),e.hotNode=i,n&&r.fire("saveSnapshot")}function u(e,t){return{canUndo:!0,modes:{wysiwyg:1},exec:function(){function n(n){var i=z.ie&&z.version<9?" ":F,o=e.hotNode&&e.hotNode.getText()==i&&e.element.equals(e.hotNode)&&e.lastCmdDirection===!!t;s(e,function(i){o&&e.hotNode&&e.hotNode.remove(),i[t?"insertAfter":"insertBefore"](n),i.setAttributes({"data-cke-magicline-hot":1,"data-cke-magicline-dir":!!t}),e.lastCmdDirection=!!t}),z.ie||e.enterMode==CKEDITOR.ENTER_BR||e.hotNode.scrollIntoView(),e.line.detach()}return function(o){var l,d=o.getSelection().getStartElement();if(d=d.getAscendant(W,1),!E(e,d)&&d&&!d.equals(e.editable)&&!d.contains(e.editable)){(l=a(d))&&"false"==l.getAttribute("contenteditable")&&(d=l),e.element=d;var s,u=r(e,d,!t);if(c(u)&&u.is(e.triggers)&&u.is(G)&&(!r(e,u,!t)||(s=r(e,u,!t))&&c(s)&&s.is(e.triggers)))return void n(u);var g=i(e,d);if(c(g)){if(!r(e,g,!t))return void n(g);var p=r(e,g,!t);return p&&c(p)&&p.is(e.triggers)?void n(g):void 0}}}}()}}function g(e,t){if(!t||t.type!=CKEDITOR.NODE_ELEMENT||!t.$)return!1;var n=e.line;return n.wrap.equals(t)||n.wrap.contains(t)}function c(e){return e&&e.type==CKEDITOR.NODE_ELEMENT&&e.$}function p(e){if(!c(e))return!1;var t={left:1,right:1,center:1};return!(!t[e.getComputedStyle("float")]&&!t[e.getAttribute("align")])}function h(e){return c(e)?f(e)||p(e):!1}function f(e){return!!{absolute:1,fixed:1}[e.getComputedStyle("position")]}function b(e){return e&&e.type==CKEDITOR.NODE_TEXT}function m(e,t){return c(t)?t.is(e.triggers):null}function E(e,t){if(!t)return!1;for(var n=t.getParents(1),i=n.length;i--;)for(var o=e.tabuList.length;o--;)if(n[i].hasAttribute(e.tabuList[o]))return!0;return!1}function w(e,t,n){var i=t[n?"getLast":"getFirst"](function(t){return e.isRelevant(t)&&!t.is(U)});return i?(y(e,i),n?i.size.top>e.mouse.y:i.size.bottom<e.mouse.y):!1}function v(e){e.debug.groupStart("triggerEditable");var t,i=e.editable,o=e.mouse,r=e.view,a=e.triggerOffset;D(e);var d=o.y>(e.inInlineMode?r.editable.top+r.editable.height/2:Math.min(r.editable.height,r.pane.height)/2),s=i[d?"getLast":"getFirst"](function(e){return!(Q(e)||Z(e))});return s?(g(e,s)&&(s=e.line.wrap[d?"getPrevious":"getNext"](function(e){return!(Q(e)||Z(e))})),c(s)&&!h(s)&&m(e,s)?(y(e,s),!d&&s.size.top>=0&&l(o.y,0,s.size.top+a)?(t=e.inInlineMode||0===r.scroll.y?B:q,e.debug.logEnd("SUCCESS. Created box trigger. EDGE_TOP."),new n([null,s,L,A,t])):d&&s.size.bottom<=r.pane.height&&l(o.y,s.size.bottom-a,r.pane.height)?(t=e.inInlineMode||l(s.size.bottom,r.pane.height-a,r.pane.height)?$:q,e.debug.logEnd("SUCCESS. Created box trigger. EDGE_BOTTOM."),new n([s,null,P,A,t])):(e.debug.logEnd("ABORT. No trigger created."),null)):(e.debug.logEnd("ABORT. Invalid edge node."),null)):(e.debug.logEnd("ABORT. No edge node found."),null)}function x(e){e.debug.groupStart("triggerEdge");var t=e.mouse,o=e.view,a=e.triggerOffset,d=i(e);if(e.debug.logElements([d],["Ascendant trigger"],"First stage"),!d)return e.debug.logEnd("ABORT. No element, element is editable or element contains editable."),null;y(e,d);var s,u,g=Math.min(a,0|d.size.outerHeight/2),p=[];if(l(t.y,d.size.top-1,d.size.top+g))u=!1;else{if(!l(t.y,d.size.bottom-g,d.size.bottom+1))return e.debug.logEnd("ABORT. Not around of any edge."),null;u=!0}if(h(d)||w(e,d,u)||d.getParent().is(H))return e.debug.logEnd("ABORT. element is wrong",d),null;var f=r(e,d,!u);if(f){if(b(f))return e.debug.logEnd("ABORT. Sibling is non-empty text element"),null;if(c(f)){if(h(f)||!m(e,f)||f.getParent().is(H))return e.debug.logEnd("ABORT. elementSibling is wrong",f),null;p=[f,d][u?"reverse":"concat"]().concat([K,A]),e.debug.log("Configured edge trigger of EDGE_MIDDLE")}}else d.equals(e.editable[u?"getLast":"getFirst"](e.isRelevant))?(D(e),u&&l(t.y,d.size.bottom-g,o.pane.height)&&l(d.size.bottom,o.pane.height-g,o.pane.height)?s=$:l(t.y,0,d.size.top+g)&&(s=B)):s=q,p=[null,d][u?"reverse":"concat"]().concat([u?P:L,A,s,d.equals(e.editable[u?"getLast":"getFirst"](e.isRelevant))?u?$:B:q]),e.debug.log("Configured edge trigger of "+(u?"EDGE_BOTTOM":"EDGE_TOP"));return 0 in p?(e.debug.logEnd("SUCCESS. Returning a trigger."),new n(p)):(e.debug.logEnd("ABORT. No trigger generated."),null)}function T(e,t,n,i){function o(e){return t.getComputedStyle.call(t,e)}for(var r=t.getDocumentPosition(),l={},a={},d={},s={},u=te.length;u--;)l[te[u]]=parseInt(o("border-"+te[u]+"-width"),10)||0,d[te[u]]=parseInt(o("padding-"+te[u]),10)||0,a[te[u]]=parseInt(o("margin-"+te[u]),10)||0;return n&&!i||C(e,i),s.top=r.y-(n?0:e.view.scroll.y),s.left=r.x-(n?0:e.view.scroll.x),s.outerWidth=t.$.offsetWidth,s.outerHeight=t.$.offsetHeight,s.height=s.outerHeight-(d.top+d.bottom+l.top+l.bottom),s.width=s.outerWidth-(d.left+d.right+l.left+l.right),s.bottom=s.top+s.outerHeight,s.right=s.left+s.outerWidth,e.inInlineMode&&(s.scroll={top:t.$.scrollTop,left:t.$.scrollLeft}),O({border:l,padding:d,margin:a,ignoreScroll:n},s,!0)}function y(e,t,n){if(!c(t))return t.size=null;if(t.size){if(t.size.ignoreScroll==n&&t.size.date>new Date-V)return e.debug.log("element.size: get from cache"),null}else t.size={};return e.debug.log("element.size: capture"),O(t.size,T(e,t,n),{date:+new Date},!0)}function D(e,t){e.view.editable=T(e,e.editable,t,!0)}function C(e,t){e.view||(e.view={});var n=e.view;if(!t&&n&&n.date>new Date-V)return void e.debug.log("win.size: get from cache");e.debug.log("win.size: capturing");var i=e.win,o=i.getScrollPosition(),r=i.getViewPaneSize();O(e.view,{scroll:{x:o.x,y:o.y,width:e.doc.$.documentElement.scrollWidth-r.width,height:e.doc.$.documentElement.scrollHeight-r.height},pane:{width:r.width,height:r.height,bottom:r.height+o.y},date:+new Date},!0)}function R(e,t,i,o){for(var r=o,l=o,a=0,d=!1,s=!1,u=e.view.pane.height,g=e.mouse;g.y+a<u&&g.y-a>0&&(d||(d=t(r,o)),s||(s=t(l,o)),!d&&g.y-a>0&&(r=i(e,{x:g.x,y:g.y-a})),!s&&g.y+a<u&&(l=i(e,{x:g.x,y:g.y+a})),!d||!s);)a+=2;return new n([r,l,null,null])}CKEDITOR.plugins.add("magicline",{lang:"en",init:e});var O=CKEDITOR.tools.extend,I=CKEDITOR.dom.element,M=I.createFromHtml,z=CKEDITOR.env,N=CKEDITOR.env.ie&&CKEDITOR.env.version<9,S=CKEDITOR.dtd,k={},L=128,P=64,K=32,A=16,_=8,B=4,$=2,q=1,F=" ",H=S.$listItem,U=S.$tableContent,G=O({},S.$nonEditable,S.$empty),W=S.$block,V=100,X="width:0px;height:0px;padding:0px;margin:0px;display:block;z-index:9999;color:#fff;position:absolute;font-size: 0px;line-height:0px;",j=X+"border-color:transparent;display:block;border-style:solid;",Y="<span>"+F+"</span>";k[CKEDITOR.ENTER_BR]="br",k[CKEDITOR.ENTER_P]="p",k[CKEDITOR.ENTER_DIV]="div",n.prototype={set:function(e,t,n){return this.properties=e+t+(n||q),this},is:function(e){return(this.properties&e)==e}};var J=function(){function e(e,t){var n=e.$.elementFromPoint(t.x,t.y);return n&&n.nodeType?new CKEDITOR.dom.element(n):null}return function(t,n,i){if(!t.mouse)return null;var o=t.doc,r=t.line.wrap,l=i||t.mouse,a=e(o,l);return n&&g(t,a)&&(r.hide(),a=e(o,l),r.show()),a&&a.type==CKEDITOR.NODE_ELEMENT&&a.$?z.ie&&z.version<9&&!t.boundary.equals(a)&&!t.boundary.contains(a)?null:a:null}}(),Q=CKEDITOR.dom.walker.whitespaces(),Z=CKEDITOR.dom.walker.nodeType(CKEDITOR.NODE_COMMENT),ee=function(){function e(e){e.debug.groupStart("expandEngine");var r,l,a,d=e.element;if(!c(d)||d.contains(e.editable))return e.debug.logEnd("ABORT. No start element, or start element contains editable."),null;if(d.isReadOnly())return null;if(a=R(e,function(e,t){return!t.equals(e)},function(e,t){return J(e,!0,t)},d),r=a.upper,l=a.lower,e.debug.logElements([r,l],["Upper","Lower"],"Pair found"),t(e,r,l))return e.debug.logEnd("SUCCESS. Expand trigger created."),a.set(K,_);if(e.debug.logElements([d,r,l],["Start","Upper","Lower"],"Post-processing"),r&&d.contains(r))for(;!r.getParent().equals(d);)r=r.getParent();else r=d.getFirst(function(t){return n(e,t)});if(l&&d.contains(l))for(;!l.getParent().equals(d);)l=l.getParent();else l=d.getLast(function(t){return n(e,t)});if(!r||!l)return e.debug.logEnd("ABORT. There is no upper or no lower element."),null;if(y(e,r),y(e,l),!i(e,r,l))return e.debug.logEnd("ABORT. Mouse is already above upper or below lower."),null;for(var s,u,g,p,h=Number.MAX_VALUE;l&&!l.equals(r)&&(u=r.getNext(e.isRelevant));)s=Math.abs(o(e,r,u)-e.mouse.y),h>s&&(h=s,g=r,p=u),r=u,y(e,r);return e.debug.logElements([g,p],["Min","MinNext"],"Post-processing results"),g&&p?i(e,g,p)?(a.upper=g,a.lower=p,e.debug.logEnd("SUCCESSFUL post-processing. Trigger created."),a.set(K,_)):(e.debug.logEnd("ABORT. Mouse is already above minElement or below minElementNext."),null):(e.debug.logEnd("ABORT. No Min or MinNext"),null)}function n(e,t){return!(b(t)||Z(t)||h(t)||g(e,t)||t.type==CKEDITOR.NODE_ELEMENT&&t.$&&t.is("br"))}function i(e,t,n){return l(e.mouse.y,t.size.top,n.size.bottom)}function r(e,n){e.debug.groupStart("expandFilter");var i=n.upper,o=n.lower;return!i||!o||h(o)||h(i)||o.equals(i)||i.equals(o)||o.contains(i)||i.contains(o)?(e.debug.logEnd("REJECTED. No upper or no lower or they contain each other."),!1):m(e,i)&&m(e,o)&&t(e,i,o)?(e.debug.logElementsEnd([i,o],["upper","lower"],"APPROVED EDGE_MIDDLE"),!0):(e.debug.logElementsEnd([i,o],["upper","lower"],"Rejected unknown pair"),!1)}return function(t){t.debug.groupStart("triggerExpand");var n=e(t);return t.debug.groupEnd(),n&&r(t,n)?n:null}}(),te=["top","left","right","bottom"]}(),CKEDITOR.config.magicline_keystrokePrevious=CKEDITOR.CTRL+CKEDITOR.SHIFT+51,CKEDITOR.config.magicline_keystrokeNext=CKEDITOR.CTRL+CKEDITOR.SHIFT+52;